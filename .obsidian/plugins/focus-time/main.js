/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var S=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var O=(r,t)=>{for(var a in t)S(r,a,{get:t[a],enumerable:!0})},$=(r,t,a,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of N(t))!z.call(r,i)&&i!==a&&S(r,i,{get:()=>t[i],enumerable:!(e=k(t,i))||e.enumerable});return r};var W=r=>$(S({},"__esModule",{value:!0}),r);var H={};O(H,{default:()=>P});module.exports=W(H);var L=require("obsidian");var f=require("obsidian");var A={minutes:"{minute}m",hours_minutes:"{hour}h {minute}m",language:"Language",strictMode:"Strict mode",strictModeDesc:"Timer will be suspend if the window lost focus while the strict mode activated.",leaderboardTitle:"\u{1F9D0} Total focus time data",leaderboardNoData:"No data available, start reading now!",leaderboardNoData2:"Only notes with focus time greater than 1 minute are counted",openLeaderboardModal:"View total focus time data",fileNotFound:"File not found"};var B={minutes:"{minute}\u5206\u949F",hours_minutes:"{hour}\u5C0F\u65F6 {minute}\u5206\u949F",language:"\u8BED\u8A00",strictMode:"\u4E25\u683C\u6A21\u5F0F",strictModeDesc:"\u5F00\u542F\u4E25\u683C\u6A21\u5F0F\u540E\uFF0C\u5F53\u7A97\u53E3\u5931\u53BB\u7126\u70B9\u65F6\uFF0C\u8BA1\u65F6\u5C06\u4F1A\u6682\u505C\u3002",leaderboardTitle:"\u{1F9D0} \u603B\u4E13\u6CE8\u65F6\u957F\u6570\u636E",leaderboardNoData:"\u6682\u65E0\u6570\u636E\uFF0C\u5FEB\u53BB\u9605\u8BFB\u5427\uFF01",leaderboardNoData2:"\u4EC5\u7EDF\u8BA1\u4E13\u6CE8\u65F6\u957F\u5927\u4E8E1\u5206\u949F\u7684\u7B14\u8BB0",openLeaderboardModal:"\u67E5\u770B\u603B\u4E13\u6CE8\u65F6\u957F\u6570\u636E",fileNotFound:"\u6587\u4EF6\u4E0D\u5B58\u5728"};var I=require("obsidian"),o=class{constructor(t="en"){this.translations={en:A,zh:B};this.language=t}static getInstance(t="en"){return o.instance||(o.instance=new o(t)),o.instance}setLanguage(t){this.language=t}t(t,a={}){let e=this.translations[this.language]?this.translations[this.language][t]:this.translations.en[t];return Object.keys(a).forEach(i=>{e=e.replace(`{${i}}`,String(a[i]))}),e}static t(t,a={}){return o.getInstance().t(t,a)}static autoDetectLanguage(t="en"){return I.moment.locale().split("-")[0]||t}},s=o;var h=class extends f.PluginSettingTab{constructor(a,e){super(a,e);this.plugin=e}display(){let{containerEl:a}=this;a.empty(),this.addStrictModeSetting(a)}addStrictModeSetting(a){let e=this.plugin.dataManager.get("settings","strictMode");new f.Setting(a).setName(s.t("strictMode")).setDesc(s.t("strictModeDesc")).addToggle(i=>i.setValue(e!==void 0?e:!0).onChange(n=>{this.plugin.dataManager.put("settings","strictMode",n).finally()}))}};var c=require("obsidian");var l=class{static getFormattedReadingTime(t){let a=t/1e3/60,e=Math.floor(a/60),i=Math.floor(a%60);return e===0?s.t("minutes",{minute:i.toFixed(0)}):s.t("hours_minutes",{hour:e,minute:i.toFixed(0)})}static getDateToday(){let t=new Date,a=t.getFullYear(),e=t.getMonth()+1,i=t.getDate();return`${a}-${e}-${i}`}};var u=class extends c.Modal{constructor(a,e){super(e);this.plugin=a}onOpen(){let{contentEl:a}=this;a.empty(),a.createEl("h2",{text:s.t("leaderboardTitle"),cls:"leaderboard-modal-title"});let e=this.plugin.dataAnalyzer.analyzeLeaderboardTotal();if(!e||e.length===0){a.createEl("p",{text:s.t("leaderboardNoData"),cls:"leaderboard-no-data"}),a.createEl("p",{text:s.t("leaderboardNoData2"),cls:"leaderboard-no-data"});return}let i=a.createDiv({cls:"leaderboard-container"});e.forEach((n,p)=>{let m=l.getFormattedReadingTime(n.totalTime),x=i.createDiv({cls:"leaderboard-entry"});x.addEventListener("click",()=>{this.openFileInWorkspace(n),this.close()}),x.createEl("span",{text:`${p+1}. `+this.getFormattedNoteName(n.filePath),title:n.filePath,cls:"leaderboard-file-name"}),x.createEl("span",{text:m,cls:"leaderboard-time"})})}onClose(){let{contentEl:a}=this;a.empty()}openFileInWorkspace(a){let e=this.app.vault.getFileByPath((0,c.normalizePath)(a.fileRecord.filePath));if(!e){new c.Notice(s.t("fileNotFound"));return}this.app.workspace.getLeaf().openFile(e).finally()}getFormattedNoteName(a){var i;let e=(i=a.split("/").pop())!=null?i:"";return e.length>25?e.substring(0,25)+"...":e}};var D=class{constructor(t,a){this.plugin=t,this.app=a}create(){this.plugin.addCommand({id:"open-leaderboard",name:"Open leaderboard",callback:()=>{new u(this.plugin,this.app).open()}})}};var y=class{static generateFileId(t){return t.path}};var v=class{constructor(t){this.plugin=t,this.statusBar=this.plugin.addStatusBarItem()}display(t,a,e){t.render(this.statusBar,a,e)}remove(){this.statusBar.empty()}};var C=require("obsidian"),g=class{render(t,a,e){t.empty(),e&&(0,C.setIcon)(t,e),t.createEl("span",{text:a,cls:"reading-time-text"})}};var b=class{static createIconTextStatusBar(t,a){let e=l.getFormattedReadingTime(a);t.display(new g,e,"book-open-text")}static createTextStatusBar(t,a){t.display(new g,a)}};var d=class{static setCurrentFile(t){this.currentFile=t}static getCurrentFile(){return this.currentFile}};d.currentFile=null;var M=class{constructor(t,a,e,i){this.globalRefreshTime=1e3*6;this.windowFocus=!0;this.app=a,this.dataManager=e,this.dailyReadDataManager=i,this.statusBarManager=new v(t),t.registerEvent(this.app.workspace.on("file-open",()=>this.handleFileChange())),t.registerInterval(window.setInterval(()=>this.handleRefresh(),this.globalRefreshTime)),window.addEventListener("focus",()=>this.handleWindowFocus()),window.addEventListener("blur",()=>this.handleWindowBlur())}handleRefresh(){this.refreshAndSave(this.globalRefreshTime),this.updateStatusBar()}updateStatusBar(){var a;let t=d.getCurrentFile();if(t){let e=this.getTotalReadData(t);b.createIconTextStatusBar(this.statusBarManager,(a=e==null?void 0:e.duration)!=null?a:0)}else this.statusBarManager.remove()}handleFileChange(){let t=this.app.workspace.getActiveFile(),a=d.getCurrentFile();a&&a!==t&&this.incTotalReadCount(a),d.setCurrentFile(t),this.updateStatusBar()}handleWindowFocus(){this.windowFocus=!0}handleWindowBlur(){this.windowFocus=!1}refreshAndSave(t){let a=d.getCurrentFile();if(!a||this.needSuspendTimer())return;this.dailyReadDataManager.loadTodayData().then(i=>{let n=i.dailyReadData?i.dailyReadData[this.getFileId(a.path)]:void 0;this.saveDailyReadData(a,n?n.duration+t:t)});let e=this.getTotalReadData(a);this.saveTotalReadData(a,e?e.duration+t:t,e?e.openCount:1)}saveDailyReadData(t,a){let e=this.buildReadData(t,a,0,!0);this.dailyReadDataManager.saveTodayData("dailyReadData",e).finally()}saveTotalReadData(t,a,e){let i=this.buildReadData(t,a,e,!1);this.dataManager.put("readData",i.filePath,i).finally()}buildReadData(t,a,e,i){return i?{filePath:"",openCount:0,fileId:this.getFileId(t.path),duration:a}:{fileId:this.getOrCreateFileId(t.path),filePath:t.path,duration:a,openCount:e}}getOrCreateFileId(t){let a=this.dataManager.get("readData",t);return a&&a.fileId?a.fileId:Date.now().toString()}getFileId(t){let a=this.dataManager.get("readData",t);if(a&&a.fileId)return a.fileId}incTotalReadCount(t){let a=this.getTotalReadData(t),e=this.buildReadData(t,a?a.duration:0,a?a.openCount+1:1,!1);this.saveTotalReadData(t,e.duration,e.openCount)}getTotalReadData(t){return this.dataManager.get("readData",y.generateFileId(t))}unload(){this.statusBarManager.remove()}isStrictMode(){var t;return(t=this.dataManager.get("settings","strictMode"))!=null?t:!0}needSuspendTimer(){return this.isStrictMode()&&!this.windowFocus}};var F=class{constructor(t){this.data={};this.plugin=t}async loadData(){let t=await this.plugin.loadData();this.data=t||{}}async saveData(){await this.plugin.saveData(this.data)}async put(t,a,e){this.data[t]||(this.data[t]={}),this.data[t][a]=e,await this.saveData()}get(t,a){var e;return(e=this.data[t])==null?void 0:e[a]}getCategory(t){return this.data[t]}async delete(t,a){this.data[t]&&(delete this.data[t][a],await this.saveData())}async deleteCategory(t){this.data[t]&&(delete this.data[t],await this.saveData())}};var E=require("obsidian");var T=class{constructor(t){this.app=t,this.dataDir=`${t.vault.configDir}/plugins/focus-time/data`,this.mkdir().finally()}async mkdir(){await this.app.vault.adapter.mkdir((0,E.normalizePath)(this.dataDir))}async saveTodayData(t,a){let e=l.getDateToday(),i=this.getFilePath(e),n=await this.loadTodayData();n[t]||(n[t]={}),n[t][`${a.fileId}`]=a;let p=JSON.stringify(n,null,2);await this.saveFile(i,p)}async loadTodayData(){return this.loadDailyData(l.getDateToday())}async loadDailyData(t){let a=this.getFilePath(t);if(await this.app.vault.adapter.exists(a)){let e=await this.app.vault.adapter.read(a);return JSON.parse(e)}return{}}getFilePath(t){return`${this.dataDir}/${t}.json`}async saveFile(t,a){await this.app.vault.adapter.write(t,a)}};var R=class{constructor(t,a,e,i){this.plugin=t,this.app=a,this.dataManager=e,this.dailyReadDataManager=i,t.registerEvent(this.app.vault.on("rename",(n,p)=>{let m=this.app.vault.getFileByPath(n.path);m&&this.onFileRename(m,p)}))}analyzeLeaderboardTotal(){let t=this.dataManager.getCategory("readData");if(!t)return;let a=Object.keys(t).map(e=>{let i=t[e],n=i.duration,p=t[e].filePath;return{fileRecord:i,filePath:p,totalTime:n}});return a.sort((e,i)=>i.totalTime-e.totalTime),a.filter(e=>e.totalTime>60*1e3)}onFileRename(t,a){let e=this.dataManager.get("readData",a);e&&(e.filePath=t.path,this.dataManager.delete("readData",a).finally(),this.dataManager.put("readData",t.path,e).finally())}};var w=class{static createLeaderboardRibbon(t,a){t.addRibbonIcon("book-open-text",s.t("openLeaderboardModal"),e=>{new u(t,a).open()})}};var P=class extends L.Plugin{get dataAnalyzer(){return this._dataAnalyzer}get dataManager(){return this._dataManager}async onload(){this._dataManager=new F(this),this.dailyReadDataManager=new T(this.app),this.dataManager.loadData().then(()=>{this.init()})}onunload(){this.timeTracker.unload()}init(){this.setLanguage(),this.timeTracker=new M(this,this.app,this._dataManager,this.dailyReadDataManager),this._dataAnalyzer=new R(this,this.app,this._dataManager,this.dailyReadDataManager),this.addSettingTab(new h(this.app,this)),w.createLeaderboardRibbon(this,this.app),new D(this,this.app).create()}setLanguage(){s.getInstance().setLanguage(s.autoDetectLanguage())}};

/* nosourcemap */